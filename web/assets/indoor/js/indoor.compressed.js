L.indoor={latLng:function(r,s,t){r=new L.LatLng(r,s);r.level=t;return r},map:function(r,s,t,x){function l(){for(var a in n.polygons)for(var b in n.polygons[a])c.hasLayer(n.polygons[a][b].polygon)&&c.removeLayer(n.polygons[a][b].polygon);n.polygons={}}function q(){l();for(var a in n.specifiedAreas){var b=n.specifiedAreas[a],g=b.feature,e=[];if(g.geometry)e.push(g);else e=g;for(g=0;g<e.length;g++){var d=new L.Polygon(e[g].geometry.coordinates,b.style);e[g].levelIndex==m.levelIndex&&d.addTo(c).bringToFront();
n.polygons[m.levelIndex]||(n.polygons[m.levelIndex]=[]);n.polygons[m.levelIndex].push({feature:e[g],polygon:d})}}for(var f in n.areas){b=n.areas[f];for(var h in m.geojson.features){g=m.geojson.features[h];a=true;for(var o in b.parameters)if(b.parameters[o]!=g.properties[o])a=false;if(a&&g.geometry.coordinates[0].length>0){d=(new L.Polygon(g.geometry.coordinates,b.style)).addTo(c).bringToFront();n.polygons[m.levelIndex]||(n.polygons[m.levelIndex]=[]);n.polygons[m.levelIndex].push({feature:g,polygon:d})}}}}
function u(a){D=a;if(m){c.removeLayer(m.tileLayer);c.removeLayer(m.gridLayer);m.markerLayer&&c.hasLayer(m.markerLayer)&&c.removeLayer(m.markerLayer)}$("#level_chooser a").attr("class","");$("#level_chooser a[level="+a+"]").attr("class","leaflet-disabled");var b=L.mapbox.tileLayer(i[a]);c.addLayer(b);var g=L.mapbox.gridLayer(i[a]);c.addLayer(g);c.addControl(L.indoor.gridControl(g,{click:s.click,hover:s.hover}));i[a].gridLayer=g;i[a].tileLayer=b;m=i[a];try{y.bringToBack()}catch(e){}for(var d in c._layers)if(c._layers[d]._latlng)if(c._layers[d]._latlng.level)if(c._layers[d]._latlng.level==
c.getLevel()&&c._layers[d].setOpacity)c._layers[d].setOpacity(1);else c._layers[d].setOpacity&&c._layers[d].setOpacity(0);q();E();return c}function E(){for(var a in k)if(k[a]){for(var b in k[a].levels)c.hasLayer(k[a].levels[b].polyline)&&c.removeLayer(k[a].levels[b].polyline);c.hasLayer(k[a].startMarker)&&c.removeLayer(k[a].startMarker);c.hasLayer(k[a].endMarker)&&c.removeLayer(k[a].endMarker);if(k[a].data.length>0){k[a].levels[m.levelIndex].polyline&&c.addLayer(k[a].levels[m.levelIndex].polyline);
k[a].data[0].levelIndex==m.levelIndex&&c.addLayer(k[a].startMarker);k[a].data[k[a].data.length-1].levelIndex==m.levelIndex&&c.addLayer(k[a].endMarker)}}}function F(a){if(a.data.length!=0){if(!a.options.animateIcon)a.options.animateIcon=new L.divIcon({html:"X"});if(!a.headMarker&&a.data.length>0)a.headMarker=new L.marker(new L.LatLng(a.data[0].lat,a.data[0].lng),{icon:a.options.animateIcon});if(a.status.animationProgress==undefined)a.status.animationProgress=0;if(!a.totalLength){for(var b=a.totalLength=
0;b<a.data.length-1;b++){a.data[b].distanceToNext=Math.sqrt(Math.pow(a.data[b].lat-a.data[b+1].lat,2)+Math.pow(a.data[b].lng-a.data[b+1].lng,2));a.data[b].totalDistanceToThis=a.totalLength;a.totalLength+=a.data[b].distanceToNext}a.data[a.data.length-1].totalDistanceToThis=a.totalLength;a.data[a.data.length-1].distanceToNext=-1;a.status.animationMax=a.totalLength/5.640361071184976E-4*60;a.animationPoints=[];for(var g=a.totalLength/(a.status.animationMax-1),e=0;e<a.status.animationMax;e++){var d=e*
g,f=a.data[0],h=a.data[0];for(b=0;b<a.data.length-1&&a.data[b].totalDistanceToThis<d;b++){f=h;h=a.data[b+1]}if(f==h)a.animationPoints.push(f);else{b=(d-f.totalDistanceToThis)/f.distanceToNext;a.animationPoints.push({lat:f.lat+b*(h.lat-f.lat),lng:f.lng+b*(h.lng-f.lng),level:f.level})}}}g=0;if(a.status.animationProgress>=a.status.animationMax){a.animationComplete=true;a.status.animationProgress=undefined;c.hasLayer(a.headMarker)&&c.removeLayer(a.headMarker)}else{c.hasLayer(a.headMarker)||c.addLayer(a.headMarker);
e=new L.LatLng(a.animationPoints[a.status.animationProgress].lat,a.animationPoints[a.status.animationProgress].lng);a.headMarker.setLatLng(e);c.panTo(e);if(c.getLevel()!=a.animationPoints[a.status.animationProgress].level){c.setLevel(a.animationPoints[a.status.animationProgress].level);g=1}}if(!a.animationComplete){a.status.animationProgress=Math.min(a.status.animationProgress+1,a.status.animationMax);setTimeout(function(){F(a)},1E3/15+1E3*g)}}}t||(t={});var G=$(document.getElementById(r));G.css("opacity",
1.0E-5);var c=new L.mapbox.map(r,undefined,t),y=L.mapbox.tileLayer({tiles:[window.location.protocol+"//c.tiles.mapbox.com/v3/examples.map-szwdot65/{z}/{x}/{y}.png"],scheme:"xyz",version:"1.0.0",center:[0,0],maxzoom:18,minzoom:1}),B=false;c.enableStreetMap=function(){if(B){console.log("indoor.js warning: street map can't be enabled if the map isn't in a mercator projection.");console.log("indoor.js warning: the projection is defined in the export process by indoor.io. please re-export.")}else c.hasLayer(y)||
c.addLayer(y)};c.disableStreetMap=function(){c.hasLayer(y)&&c.removeLayer(y)};var H=false,m=undefined,i={},C=undefined,I=false,D=0,J=undefined,n={areas:{},poi:{},polygons:{},specifiedAreas:{}};c.getFeatures=function(a,b){var g=typeof a=="function"?a:typeof b=="function"?b:null,e=typeof a=="object"?a:typeof b=="object"?b:null,d=typeof a=="string"?a:typeof b=="string"?b:null,f=[];if(!d&&!e)for(var h in i){if(i[h]==m)for(var o in i[h].geojson.features){var j=i[h].geojson.features[o];f.push(j)}}else if(d)for(h in i)for(o in i[h].geojson.features){j=
i[h].geojson.features[o];j.level=i[h].name;j.properties.level=j.level;j.levelIndex=i[h].levelIndex;var p=false,v;for(v in j.properties)if(d==j.properties[v])p=true;p&&j.geometry.coordinates[0].length>0&&f.push(j)}else if(e){d=true;for(j in e)d=false;if(d)for(h in i)for(o in i[h].geojson.features){j=i[h].geojson.features[o];j.level=i[h].name;j.properties.level=j.level;j.levelIndex=i[h].levelIndex;p=false;for(v in j.properties)if((new String(j.properties[v])).match(e))p=true;p&&j.geometry.coordinates[0].length>
0&&f.push(j)}else for(h in i)for(o in i[h].geojson.features){j=i[h].geojson.features[o];j.level=j.properties.level=i[h].name;j.levelIndex=i[h].levelIndex;p=true;for(v in e)if(j.properties[v])if(typeof e[v]=="string"){if(j.properties[v]!=e[v])p=false}else(new String(j.properties[v])).match(e[v])||(p=false);else p=false;p&&j.geometry.coordinates[0].length>0&&f.push(j)}}e=null;if(g){e=[];for(j=0;j<f.length;j++)g(f[j])!==false&&e.push(f[j])}else e=f;return e};c.fitFeatures=function(a){a=a.geometry?[a]:
a;c.fitBounds(a[0].geometry.coordinates);c.setLevel(a[0].level)};c.clearHighlight=function(a){a=typeof a=="string"?a:a.id;n.specifiedAreas[a]&&delete n.specifiedAreas[a];n.areas[a]&&delete n.areas[a];q()};c.highlightFeatures=function(a,b){var g=Math.floor(Math.random()*Math.pow(10,10));n.specifiedAreas[g]={id:g,feature:a,style:b};q();return n.specifiedAreas[g]};c.clearHighlights=function(){l();n.areas={};n.specifiedAreas={}};c.convertLatLng=function(a,b){B?$.ajax({processData:false,type:"POST",data:"data="+
JSON.stringify({lat:a.lat,lng:a.lng}),dataType:"jsonp",jsonp:"callback",contentType:"application/json",url:window.location.protocol+"//tiles.indoor.io/export/web/"+s.map+"/"+z+"/convertLatLng"}).done(function(g){b(null,new L.LatLng(g.lat,g.lng))}).fail(function(g){b(g)}):b(null,new L.LatLng(a.lat,a.lng))};c.setFeatureStyleFunction=function(a){J=a;if(m){a=i[c.getLevel()].markerLayer._layers;for(var b in a)J(a[b].feature,a[b].options)}};c.setMarkerFilterFunction=function(a){A=a;if(i[c.getLevel()].geojson&&
A){if(!(i[c.getLevel()].markerLayer&&c.hasLayer(i[c.getLevel()].markerLayer)))i[c.getLevel()].markerLayer=(new L.mapbox.markerLayer(i[c.getLevel()].geojson)).addTo(c);i[c.getLevel()].markerLayer.setFilter(A)}};c.getLevels=function(){var a=[],b;for(b in i)a.push(b);return a};c.getLevel=function(){return D};c.setLevel=function(a){if(i[a]!=undefined)u(a);else C=a};c.toggleLevelControl=function(a){if(H!=a)if(a){var b=$(document.getElementById(r)).find(".leaflet-top.leaflet-left #level_chooser");b.length>
0?b.remove():$(document.getElementById(r)).find(".leaflet-top.leaflet-left").append('<div id="level_chooser_title" style="font-weight: bold; font-size: 13px; color: #444; text-shadow: 0px 1px 0px white; margin-left: 10px; margin-top: 10px; margin-bottom: -8px;">Levels</div>');$(document.getElementById(r)).find(".leaflet-top.leaflet-left").append('<div class="leaflet-bar leaflet-control" id="level_chooser"></div>');for(b=0;b<w.length;b++)$(document.getElementById("level_chooser")).append('<a onmousemove="if(!event) event=window.event;if( event.cancelBubble ) event.cancelBubble = true;if( event.stopPropagation ) event.stopPropagation(); if( event.preventDefault ) event.preventDefault();" onclick="if(!event) event = window.event; if( event.cancelBubble ) event.cancelBubble = true;if( event.stopPropagation ) event.stopPropagation();if( event.preventDefault ) event.preventDefault();map.setLevel(\''+
w[b]+'\');" style="font-weight: bold; cursor: hand; text-decoration: none;" level="'+w[b]+'">'+w[b]+"</a>")}else{$("#level_chooser").remove();$("#level_chooser_title").remove()}H=a};var z=null,k={},A=null;c.showRoute=function(a,b){b=b?b:{};if(!b.color)b.color="#000";var g={levels:{}},e;for(e in i)g.levels[i[e].levelIndex]={polyline:null,points:[]};var d=[],f=false,h=undefined;for(e=0;e<a.length;e++){h=a[e];f||(f=a[e]);if(a[e].l!=undefined)a[e].level=a[e].l;if(d.length==0)d.push(a[e]);else if(d[d.length-
1].levelIndex==a[e].levelIndex)d.push(a[e]);else{d.push(a[e]);g.levels[d[0].levelIndex].points.push(d);d=[a[e]]}}d.length>1&&g.levels[d[0].levelIndex].points.push(d);d=Math.floor(Math.random()*Math.pow(10,10));for(e in g.levels)g.levels[e].polyline=new L.MultiPolyline(g.levels[e].points,b.lineOptions?b.lineOptions:{});if(a.length>1){e=undefined;if(b.startIcon)e={icon:b.startIcon};g.startMarker=new L.marker(new L.LatLng(f.lat,f.lng),e);b.startIcon||g.startMarker.setOpacity(0);e=undefined;if(b.endIcon)e=
{icon:b.endIcon};g.endMarker=new L.marker(new L.LatLng(h.lat,h.lng),e);b.endIcon||g.endMarker.setOpacity(0)}k[d]=g;k[d].options=b;k[d].status={};k[d].data=a;E();k[d].options.animate&&F(k[d]);return d};c.hideRoute=function(a){if(k[a]!=undefined){for(var b in k[a].levels)k[a].levels[b].polyline&&c.hasLayer(k[a].levels[b].polyline)&&c.removeLayer(k[a].levels[b].polyline);k[a].startMarker&&c.hasLayer(k[a].startMarker)&&c.removeLayer(k[a].startMarker);k[a].endMarker&&c.hasLayer(k[a].endMarker)&&c.removeLayer(k[a].endMarker);
k[a].headMarker&&c.hasLayer(k[a].headMarker)&&c.removeLayer(k[a].headMarker);k[a].status.animationProgress=k[a].status.animationMax;k[a]=undefined}};c.getFeatureById=function(a){for(var b in i)if(i[b].geojson.index[a])return i[b].geojson.index[a];return null};c.getFeaturesAt=function(){return[]};c.getRoute=function(a,b,g){z||g("Routing not enabled on the specified map.");if(!a.level&&a.l)a.level=a.l;if(!a.l&&a.level)a.l=a.level;if(!b.level&&b.l)b.level=b.l;if(!b.l&&b.level)b.l=b.level;if(!a.lng&&
a.lon)a.lng=a.lon;if(!a.lon&&a.lng)a.lon=a.lng;if(!b.lng&&b.lon)b.lng=b.lon;if(!b.lon&&b.lng)b.lon=b.lng;var e=null,d=null;e={lat:b.lat,lng:b.lng,lon:b.lon,level:b.level,l:b.l};d={lat:a.lat,lng:a.lng,lon:a.lon,level:a.level,l:a.l};e.level=e.l=parseInt(i[e.level].levelIndex);d.level=d.l=parseInt(i[d.level].levelIndex);$.ajax({data:"data="+JSON.stringify({p1:e,p2:d,virtualCoordinates:B}),dataType:"jsonp",jsonp:"callback",url:window.location.protocol+"//tiles.indoor.io/export/web/"+s.map+"/"+z+"/graph/route.json?callback=?",
contentType:"text/json",type:"POST",processData:false}).done(function(f){for(var h in f){f[h].level=f[h].level?f[h].level:f[h].l;for(var o in i)if(f[h].level==i[o].levelIndex){f[h].levelIndex=f[h].level;f[h].l=f[h].level=i[o].name;break}}g(null,f)}).fail(function(){g("Server or connection problem. Route could not be calculated.")})};var w=[];$.ajax({dataType:"jsonp",jsonp:"callback",url:window.location.protocol+"//tiles.indoor.io/export/web/"+s.map+"/"+s.project+"?callback=?"}).done(function(a){if(typeof a==
"string")a=JSON.parse(a);for(var b in a.levels){if(!z)z=a.levels[b].source;(function(g){return function(){w.push({});$.ajax({dataType:"jsonp",jsonp:"callback",url:window.location.protocol+"//tiles.indoor.io/api/Tileset/"+a.levels[g].source+"?callback=?"}).done(function(e){return function(d){$.ajax({dataType:"jsonp",jsonp:"callback",url:window.location.protocol+"//tiles.indoor.io/export/web/"+s.map+"/"+a.levels[g].source+"/geojson.json?callback=?"}).done(function(f){if(d.bounds[0]==0&&d.bounds[1]==
0)B=true;i[d.name]=d;i[d.name].levelIndex=parseInt(g);w[e]=d.name;f.index={};for(var h in f.features){var o=f.features[h];delete o.type;o.levelIndex=i[d.name].levelIndex;if(f.features[h].properties._referenceLocation){var j=f.features[h].properties._referenceLocation.split(",");delete f.features[h].properties._referenceLocation;f.features[h].properties.markerLocation=new L.LatLng(j[1],j[0]);f.features[h].properties.markerLocation.level=d.name}if(f.features[h].properties._featureIdentifier){f.index[f.features[h].properties._featureIdentifier]=
f.features[h];f.features[h].properties.featureIdentifier=f.features[h].properties._featureIdentifier;delete f.features[h].properties._featureIdentifier}for(j=0;j<o.geometry.coordinates.length;j++)for(var p=0;p<o.geometry.coordinates[j].length;p++)o.geometry.coordinates[j][p]=new L.indoor.latLng(o.geometry.coordinates[j][p][1],o.geometry.coordinates[j][p][0],d.name)}i[d.name].geojson=f;if(c.getLevel()==d.name&&A){i[g].markerLayer=new L.mapbox.markerLayer(f);i[g].markerLayer.setFilter(A).addTo(c)}f=
0;for(var v in i)f++;if(f==a.levels.length){w.reverse();c.toggleLevelControl(true);G.hide().css("opacity",1).fadeIn();x&&x(s.project,r)}if(d.name==C&&m==undefined)u(C);else C==undefined&&m==undefined&&u(d.name);if(!I){c.setMaxBounds(new L.LatLngBounds(new L.LatLng(d.bounds[1]-(d.bounds[3]-d.bounds[1])/2,d.bounds[0]-(d.bounds[2]-d.bounds[0])/2),new L.LatLng(d.bounds[3]+(d.bounds[3]-d.bounds[1])/2,d.bounds[2]+(d.bounds[2]-d.bounds[0])/2)));c.setView(new L.LatLng(d.center[1],d.center[0]),c.getMinZoom());
I=true}})}}(g))}})(b)()}});return c},gridControl:function(r,s){var t=new L.mapbox.gridControl(r),x;for(x in s)t.options[x]=s[x];t._show=function(){};if(t.options.click)t._click=function(l){l.latLng.level=map.getLevel();var q={},u;for(u in l.data)q[u]=l.data[u];l.data=q;if(l.data._referenceLocation){q=l.data._referenceLocation.split(",");delete l.data._referenceLocation;l.data.markerLocation=new L.LatLng(q[1],q[0])}if(l.data&&l.data._featureIdentifier){q=l.data._featureIdentifier;l.feature=map.getFeatureById(q);
l.feature.properties.featureIdentifier=q;for(u in l.feature.properties)l.feature.properties[u].length==0&&delete l.feature.properties[u];delete l.feature.properties._featureIdentifier}delete l.data;this.options.click(l)};if(t.options.hover)t._mousemove=function(l){l.latLng.level=map.getLevel();if(l.data&&l.data._featureIdentifier){var q=l.data._featureIdentifier;l.feature=map.getFeatureById(q);l.feature.properties.featureIdentifier=q;for(var u in l.feature.properties)l.feature.properties[u].length==
0&&delete l.feature.properties[u];delete l.feature.properties._featureIdentifier}delete l.data;this.options.hover(l)};return t}};$(document).trigger("indoorjs");
